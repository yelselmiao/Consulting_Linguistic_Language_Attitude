---
title: "Codes for new data "
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Setup 

```{r Load Package, message=FALSE}
# read the excel 
library(readxl)
# visualization 
library(ggplot2)

# Data cleaning 
library(scales)
library(tidyverse)
library(tidyr)
library(tidytext)
# Convert data from wide to long, long to wide 
library(reshape2)

library(ggpubr)
# Repeated measures ANOA
library(rstatix)

# LME model (nlme),
library(lme4)
# demonstrate the results of LME
library(sjPlot)
# GEE model 
library(geepack)
```


```{r Load data}
#Les_diffe_rents_accents_du_franc_ais_September_15_2021 <- read_excel("Data/Les différents accents du français - September 15 2021.xlsx")
raw_data <- Les_diffe_rents_accents_du_franc_ais_September_15_2021

#remove the first line
data <- raw_data[-1, ]

# check column names
names(data)
```


```{r rename some columns, warning = FALSE, message = FALSE}
data <- data %>%
  select(-c(StartDate, Finished, Q44, Q43...143, QID18_1, QID18_2, QID18_3, QID18_4,
            QID18_5, QID18_6, QID18_7, QID18_8, QID18_9, QID18_10, QID19)) %>%
  rename(gender = Q1,
         gender_other = Q1_4_TEXT, 
         age = Q2,
         country_of_birth = Q3,
         grow_up_province = Q41,
         grow_up_city = Q4,
         field_of_study = Q5,
         num_of_language = Q6,
         spoken_language = Q42, 
         #spoken_language_other = Q42_11_TEXT,
         mother_tongue = Q7,
         mother_tongue_other = Q7_11_TEXT,
         year_of_french = Q8,
         french_speaking_place = Q9,
         french_speaking_place_other = Q9_6_TEXT,
         month_live_in_fr_env = Q43...17,
         type_of_french = Q10,
         type_of_french_other = Q10_3_TEXT,
         teacher_origin = Q11, 
         teacher_origin_other = Q11_3_TEXT
         ) %>% 
  mutate(age = as.numeric(age),
         num_of_language = as.numeric(num_of_language),
         year_of_french = as.numeric(year_of_french),
         )
  
#  check the data type of each column
#str(data) 
```


# EDA (Descriptive data and visualization) 

```{r gender}
data %>% select(gender) %>% 
  group_by(gender) %>%
  tally() %>% 
  mutate(prop = percent(n/sum(n)))
```

```{r age, warning=FALSE}
data$age <-  raw_data %>% select(Q2) %>% slice(2:n())
data$age <- as.numeric(unlist(data$age))

# summary data
data %>% 
  select(age) %>%
  drop_na() %>%
  summarize(min = min(age),
            max = max(age),
            mean = mean(age))

# visualization
data %>% select(age) %>%
  drop_na() %>% 
  ggplot(aes(x = age)) + 
  geom_density() + 
  # add a vertical line for the average value 
  geom_vline(aes(xintercept=mean(age)),
            color="blue", linetype="dashed", size=1) + 
  labs(y = 'Density', x = 'Age') + 
  annotate(x= mean(data$age, na.rm = TRUE),y=+Inf,label="Mean = 20.4",vjust= 2, hjust = - 0.1, geom="label")

```




```{r Country of Brith}
# For participants who were born in Canada, we group them by continents

as.data.frame(data %>% 
  select(country_of_birth) %>%
  filter(country_of_birth != 'Canada') %>%
  mutate(continent = case_when(country_of_birth %in% c('Pakistan', 'Philippines', 'China', 'Hong Kong (S.A.R.)', 'India', 'Iran', 'Japan', 'Kazakhstan', 'South Korea', 'Taiwan', 'Turkey', 'Israel', 'Malaysia', 'Viet Nam', 'United Arab Emirates', 'Brunei Darussalam', 'Iraq') ~ 'Asia',
                              country_of_birth %in% c('Brazil', 'Colombia', 'United States of America', 'Dominica', 'USA') ~ 'America',
                              country_of_birth %in% c('Croatia', 'Czech Republic', 'Russian Federation', 'United Kingdom of Great Britain and Northern Ireland', 'Ukraine', 'Turkey', 'Romania', 'Monaco') ~ 'Europe',
                              country_of_birth %in% c('Mauritius', 'Tunisia') ~ 'Africa')) %>%
      group_by(continent) %>% 
  tally() %>% 
  rename(Continent = continent)) %>%  
  slice_head(n = 3) %>%
  ggplot(aes(x = Continent, y = n, fill = Continent)) + 
  geom_col() + 
  labs(y = 'Count', x = 'Continent') + 
  geom_text(aes(label = n), vjust = -0.5) 

```

```{r province/territory}
# For participants who were born in Canada
data %>% 
  filter(country_of_birth == 'Canada') %>%
  select(grow_up_province) %>% 
  mutate(Grow_up_Province = ifelse(grow_up_province == "BC", 'Live in BC', 'Live outside BC')) %>%
  group_by(Grow_up_Province) %>%
  tally() 

```
```{r Field of Study}
# To check how many people major in French
# TRUE: major in French
# FALSE: not major in French
data %>% select(field_of_study) %>%
  mutate(french_major = ifelse(str_detect(field_of_study, "French"), TRUE, FALSE)) %>%
  group_by(french_major) %>% 
  tally()
```


```{r Number of Languages They Speak}
# drop missing values
language_df <- as.data.frame(data %>% 
                                group_by(num_of_language) %>%
                                tally() %>% 
                                drop_na())

# Reorder the levels
  
language_df$num_of_language <- factor(language_df$num_of_language, levels = c("1", "2", "3", "4"))

# visualization
language_df %>% 
  rename(`Number of Spoken Language(s)` = num_of_language) %>% 
  ggplot(aes(x= `Number of Spoken Language(s)`, y= n, fill = `Number of Spoken Language(s)`)) + 
  geom_col() + 
  geom_text(aes(label = n), vjust = - 0.5) + 
  xlab("Number of Spoken Language(s)") + 
  ylab('Count')

# count of French speaker: 85
nrow(data %>% 
  select(spoken_language) %>%
  filter(str_detect(spoken_language, 'French')))

# count of English speaker: 94 
nrow(data %>% 
  select(spoken_language) %>%
  filter(str_detect(spoken_language, 'English')))

```

```{r Mother Tongue}
# Add indicator function for each language
language_df_II <- data %>% 
  select(mother_tongue) %>%
  mutate(English = ifelse(str_detect(mother_tongue, "English") | str_detect(mother_tongue, "Anglais"), TRUE, FALSE),
         Cantonese = ifelse(str_detect(mother_tongue,"Cantonese"), TRUE, FALSE), 
         Mandarin = ifelse(str_detect(mother_tongue,"Mandarin"), TRUE, FALSE),      
         Korean = ifelse(str_detect(mother_tongue,"Korean"), TRUE, FALSE),
         Tagalog = ifelse(str_detect(mother_tongue,"Tagalog"), TRUE, FALSE),
         Anglais = ifelse(str_detect(mother_tongue,"Anglais"), TRUE, FALSE))   

# Creat a matrix to store count of mother tongues
language_count = matrix(NA, nrow = 6, ncol = 2)
language_count[,1] <- names(language_df_II)[2:7]

for (i in 1:6){
  language_count[i,2] = as.numeric(table(language_df_II[,i+1]))[2]
}

language_count <- as.data.frame(language_count)
colnames(language_count) = c('mother_tongue', 'n')

# Visualization
rbind(language_count, data %>%
  select(mother_tongue_other) %>%
  drop_na() %>%
  group_by(mother_tongue_other) %>%
  tally() %>%
  rename(mother_tongue = mother_tongue_other)) %>%
  mutate(n = as.numeric(n)) %>%
  arrange(desc(n)) %>% 
  ggplot(aes(x = reorder(mother_tongue, n), y = n)) +
  geom_col() + 
  geom_text(aes(label = n), hjust = -0.5) + 
  coord_flip() + 
  labs(x = 'First Language', y = 'Count') + 
  theme_minimal()
```

```{r Years of Studying French}
# To check the distribution of years of studying French

# group the year in 5-year interval
year_of_studying_french_df <- data %>% 
  mutate(year_group = case_when(year_of_french <= 5~"0 - 5",
                                year_of_french > 5 & year_of_french <= 10 ~"5 - 10",
                                year_of_french > 10 & year_of_french <= 15 ~"10 - 15",
                                year_of_french > 15~"> 15")) %>%
  select(year_group)

# Obtain the grouped count and calculate the proportion 
year_of_studying_french_df <- year_of_studying_french_df %>% 
  group_by(year_group) %>%
  tally() %>% 
  mutate(per =`n`/sum(`n`),
        label = paste0(n, ' (', scales::percent(per), ')'))

year_of_studying_french_df$year_group <- factor(year_of_studying_french_df$year_group, levels = c("0 - 5", "5 - 10", "10 - 15", "> 15"))

# pie chart
plot_ly(year_of_studying_french_df, labels = ~year_group, values = ~n, type = 'pie',textposition = 'outside',textinfo = 'label+percent') %>%
  layout(title = 'Year(s) of Studying French',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

# bar chart
year_of_studying_french_df %>% 
  ggplot(aes(x = year_group, y =n, fill=year_group)) +
  geom_col()+
  geom_text(aes(label = n), vjust = -0.5) + 
  labs(x = 'Year(s) of Studying French', y = 'count') + 
  theme(legend.position = "none")
  #scale_fill_discrete(name = "Year(s) of Studying French") + 

```

```{r Preferred French to Learn, fig.height=3, fig.width=5}
# calculate the grouped count and proportion
preference_df <- data %>% 
  select(type_of_french) %>% 
  group_by(type_of_french) %>%
  tally() %>% 
  mutate(per =`n`/sum(`n`),
         label = paste0(n, ' (', scales::percent(per), ')'))

# pie chart
plot_ly(preference_df, labels = ~type_of_french, values = ~n, type = 'pie',textposition = 'outside',textinfo = 'label+percent') %>%
  layout(title = 'Preferred Type of French to Learn',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

```{r Lived/Spent time in French-speaking area}
# reclean the data and divide the participants into four categories
# live in Quebec, live in France, live in other French-speaking, and none
live_in_french_env_df <- as.data.frame(t(as.data.frame(data %>% 
  select(french_speaking_place)  %>% 
  group_by(french_speaking_place) %>% 
  tally() %>% 
  mutate(live_in_France = ifelse(str_detect(french_speaking_place, 'France'), n, NA),
         live_in_quebec = ifelse(str_detect(french_speaking_place, 'Quebec'), n, NA),
         other = ifelse(french_speaking_place == 'Elsewhere:', n, NA),
         unkown = ifelse(is.na(french_speaking_place) == TRUE, n, NA)
         )%>% 
  summarize(France = sum(live_in_France, na.rm = TRUE),
               Quebec = sum(live_in_quebec, na.rm = TRUE),
               other = sum(other, na.rm = TRUE),
               unkown = sum(unkown, na.rm = TRUE)))))

live_in_french_env_df <- tibble::rownames_to_column(live_in_french_env_df, "Area")

live_in_french_env_df %>% 
  rename(count = V1) %>%
  mutate(prop = scales::percent(count/sum(count)))
``` 

```{r months of living in French-speaking area}
data$month_live_in_fr_env <- as.factor(data$month_live_in_fr_env)
levels(data$month_live_in_fr_env) <- c("1 - 3", "4 - 6", "< 1", "> 12")

data$month_live_in_fr_env <- factor(data$month_live_in_fr_env, levels = c("< 1", "1 - 3", "4 - 6", "> 12"))

data %>% 
  mutate(month_live_in_fr_env = as.factor(month_live_in_fr_env)) %>%
  select(month_live_in_fr_env) %>% 
  drop_na() %>% 
  group_by(month_live_in_fr_env) %>% 
  tally() %>% 
  mutate(per = scales::percent(n/sum(n))) %>%
  ggplot(aes(x = month_live_in_fr_env, y = n)) + 
  geom_col() + 
  geom_text(aes(label = n), vjust = -0.5) + 
  labs(x = 'Months of Living in French-speaking Places', y = 'Month') + 
  theme_minimal() 

```

```{r Teacher}
# Group by the origins of French teachers
data %>%
  select(teacher_origin, teacher_origin_other) %>%
  mutate(teacher_origin = replace(teacher_origin, teacher_origin_other == "Both French and Quebec", 'French and Quebec')) %>% 
  mutate(teacher_origin = replace(teacher_origin, teacher_origin_other == "French and Quebec", 'French and Quebec')) %>%
  mutate(teacher_origin = replace(teacher_origin, teacher_origin_other == "Quebec and French", 'French and Quebec')) %>% 
  mutate(teacher_origin = replace(teacher_origin, teacher_origin == "Elsewhere (specify)", 'Elsewhere')) %>% 
  group_by(teacher_origin) %>%
  tally() %>% 
  mutate(per = scales::percent(n/sum(n))) %>%
  drop_na() %>% 
  ggplot(aes(x = reorder(teacher_origin, n), y = n)) + 
  geom_col() + 
  coord_flip() + 
  geom_text(aes(label = n), hjust = -0.5) + 
  labs(x = 'Original of French Teacher', y = 'Count')
```

# Recording Evaluation

Speaker info for each speaker: 

1A: Quebec. White.
2A: French. Black.
3A. Acadian. Black.
4A. English. White.
5A. African. Black.
6A. Quebec. Black.
7A. African. White.
8A. Acadian. White.
9A. French. White.
10A. English. Black.


```{r Recording Evaluation Columns, warning = FALSE, message= FALSE}
recording_temp <- data %>% 
  select(c(20:129)) %>% 
  # I will leave conjecture question aside for now 
  select(-c(`1B`, `2B`, `3B`, `4B`, `4B`, `5B`, `6B`, `7B`, `8B`, `9B`, `10B`))

# rename the column to relect the speaker information 
change <- function(df, oldpref, newpref) {
  df %>%
       rename_at(vars(starts_with(oldpref)), funs(sub(oldpref, newpref, .)))
 }

recording_temp <- as.data.frame(recording_temp)

recording_temp <- change(recording_temp, '1A', 'que_w')
recording_temp <- change(recording_temp, '2A', 'fr_b')
recording_temp <- change(recording_temp, '3A', 'aca_b')
recording_temp <- change(recording_temp, '4A', 'eng_w')
recording_temp <- change(recording_temp, '5A', 'afr_b')
recording_temp <- change(recording_temp, '6A', 'que_b')
recording_temp <- change(recording_temp, '7A', 'afr_w')
recording_temp <- change(recording_temp, '8A', 'aca_w')
recording_temp <- change(recording_temp, '9A', 'fr_w')
recording_temp <- change(recording_temp, '10A', 'eng_b')

# convert the ordinal variables to numeric. It makes no harm because we have more than 5 levels
recording_temp <- as.data.frame(sapply(recording_temp, as.numeric))
```

```{r Beautiful french}
beau_fr <- recording_temp %>% 
  select(que_w_1, que_b_1, fr_b_1, fr_w_1, aca_b_1, aca_w_1, eng_w_1, eng_b_1, afr_w_1, afr_b_1) %>%
  mutate(Quebec = rowSums(.[1:2]),
         European = rowSums(.[3:4]),
         Acadian = rowSums(.[5:6]),
         `L2 French` = rowSums(.[7:8]),
         African = rowSums(.[9:10]))  %>%
  select(c(11:15)) %>%
  mutate(id = 1:nrow(recording_temp))

# convert to long format
beau_fr_long <- beau_fr %>%
  gather(key = "Accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, Accent)

# summary stat: the stats of Quebec French and European French is pretty similar
beau_fr_long %>% 
  group_by(Accent) %>%
  get_summary_stats(value, type = "mean_sd")

# Result of repeated measures ANOVA
res_beau_fr<- get_anova_table(anova_test(data = beau_fr_long, dv = value, wid = id, within = Accent))

# pairwise paired t-tests
beau_fr_pw <- beau_fr_long %>%
  pairwise_t_test(
    value ~ Accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% mutate(y.position = c(seq(12,16.5, by = 0.5)))
 

# This picture will be displayed along with plots of solitary dimensions
p_beautiful <- ggboxplot(beau_fr_long, x = "Accent", y = "value", fill = "Accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(beau_fr_pw, vjust = 0.1, bracket.nudge.y = 0.6, size = 2,hide.ns = TRUE) + 
  labs(
    subtitle = get_test_label(res_beau_fr, detailed = TRUE),
    caption = get_pwc_label(beau_fr_pw),
    title = 'Beautiful French',
    y = 'Score',
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))

```


```{r Solidarity dimension}
# Combine the score of same accents
sd_french <- recording_temp %>% 
  select(contains(c('_5', '_6', '_7'))) %>%
  mutate(que_dynamic = que_w_5 + que_b_5,
         fr_dynamic = fr_b_5 + fr_w_5,
         aca_dynamic = aca_b_5 + aca_w_5,
         eng_dynamic = eng_w_5 + eng_b_5,
         afr_dynamic = afr_b_5 + afr_w_5,
         que_nice = que_w_6 + que_b_6,
         fr_nice = fr_b_6 + fr_w_6,
         aca_nice = aca_b_6 + aca_w_6,
         eng_nice = eng_w_6 + eng_b_6,
         afr_nice = afr_b_6 + afr_w_6,
         que_social = que_w_7 + que_b_7,
         fr_social = fr_b_7 + fr_w_7,
         aca_social = aca_b_7 + aca_w_7,
         eng_social = eng_w_7 + eng_b_7,
         afr_social = afr_b_7 + afr_w_7)

# Convert to long format
dynamic_df <- sd_french %>% 
  select(que_dynamic, fr_dynamic, aca_dynamic, eng_dynamic, afr_dynamic) %>%
  rename(Quebec = que_dynamic,
         European = fr_dynamic,
         Acadian = aca_dynamic,
         `L2 French` = eng_dynamic,
         African = afr_dynamic
         ) %>% 
  mutate(id = 1: nrow(sd_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)

nice_df <- sd_french %>% 
  select(que_nice, fr_nice, aca_nice,eng_nice, afr_nice) %>%
  rename(Quebec = que_nice,
         European = fr_nice,
         Acadian = aca_nice,
         `L2 French` = eng_nice,
         African = afr_nice) %>% 
  mutate(id = 1: nrow(sd_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)

social_df <- sd_french %>% 
  select(que_social, fr_social, aca_social, eng_social, afr_social) %>%
  rename(Quebec = que_social,
         European = fr_social,
         Acadian = aca_social,
         `L2 French` = eng_social,
         African = afr_social) %>% 
  mutate(id = 1: nrow(sd_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)


--------------------------------------------------------------------------------------------------------------
# Perform repeated measures ANOVA and pair-wise t-tests are each solitary dimensions respectively  
# Dynamic
dynamic_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_dynamic <- get_anova_table(anova_test(data = dynamic_df, dv = value, wid = id, within = accent))
  

dynamic_pw <- dynamic_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1))) 

p_dynamic <- ggboxplot(dynamic_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(dynamic_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) + 
  labs(
    subtitle = get_test_label(res_dynamic, detailed = TRUE),
    caption = get_pwc_label(dynamic_pw),
    y = 'Score',
    title = 'Dynamic'
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))


--------------------------------------------------------------------------------------------------------------

# Nice

nice_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_nice <- get_anova_table(anova_test(data = nice_df, dv = value, wid = id, within = accent))
  
nice_pw <- nice_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1)))

p_nice <- ggboxplot(nice_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(nice_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) + 
  labs(
    subtitle = get_test_label(res_nice, detailed = TRUE),
    caption = get_pwc_label(nice_pw),
    title = 'Nice',
    y = 'Score',
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))

--------------------------------------------------------------------------------------------------------------


social_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_social <- get_anova_table(anova_test(data = social_df, dv = value, wid = id, within = accent))
  

social_pw <- social_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1)))

p_social <- ggboxplot(social_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(social_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) +
  labs(
    subtitle = get_test_label(res_social, detailed = TRUE),
    caption = get_pwc_label(social_pw),
    title = 'Social',
    y = 'Score',
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))
  
```


```{r Solidarity dimension - result, fig.height= 7.9, fig.width= 8}
# plot
cowplot::plot_grid(p_beautiful,p_dynamic, p_nice, p_social)


# table
res_tbl_ds <- matrix(NA, nrow = 3, ncol = 7)

res_tbl_ds[1, 1:5]  <- pull(dynamic_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)

res_tbl_ds[2, 1:5]  <-pull(nice_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)

res_tbl_ds[3, 1:5]  <- pull(social_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)


res_tbl_ds[, 6] <- c(res_dynamic$F, res_nice$F, res_social$F)
res_tbl_ds[, 7] <- c(res_dynamic$p, res_nice$p, res_social$p)

res_tbl_ds <- as.data.frame(res_tbl_ds)
colnames(res_tbl_ds) <- c('mean_Acadian', 'mean_African', 'mean_English','mean_European', 'mean_Quebec', 'F', 'p-value')
rownames(res_tbl_ds) <- c('Dynamic', 'Nice', 'Social')
res_tbl_ds
```
* General Perspective
1) I think this is beautiful French.

* Understandability
2) Is it rather easy or difficult to understand the speaker?
3) Would the person who did the recording be a good French teacher at UBC?
4) The speaker’s accent is weak, strong, or absent?

* Solidarity dimension
5) This person is dynamic.
6) This person is nice.
7) This person is social.

* Status traits
8) This person is professional.
9) This person is leader.
10) This person is educated.


```{r Status traits}
# Combine the scores of same accents
st_french <- recording_temp %>% 
  select(contains(c('_8', '_9', '_10'))) %>%
  mutate(que_prof = que_w_8 + que_b_8,
         fr_prof = fr_b_8 + fr_w_8,
         aca_prof = aca_b_8 + aca_w_8,
         eng_prof = eng_w_8 + eng_b_8,
         afr_prof = afr_b_8 + afr_w_8,
         que_lead = que_w_9 + que_b_9,
         fr_lead = fr_b_9 + fr_w_9,
         aca_lead = aca_b_9 + aca_w_9,
         eng_lead = eng_w_9 + eng_b_9,
         afr_lead = afr_b_9 + afr_w_9,
         que_edu = que_w_10 + que_b_10,
         fr_edu = fr_b_10 + fr_w_10,
         aca_edu = aca_b_10 + aca_w_10,
         eng_edu = eng_w_10 + eng_b_10,
         afr_edu = afr_b_10 + afr_w_10)

# Convert to long format
prof_df <- st_french %>% 
  select(que_prof, fr_prof, aca_prof, eng_prof, afr_prof) %>%
  rename(Quebec = que_prof,
         European = fr_prof,
         Acadian = aca_prof,
         `L2 French` = eng_prof,
         African = afr_prof
         ) %>% 
  mutate(id = 1: nrow(st_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)

lead_df <- st_french %>% 
  select(que_lead, fr_lead, aca_lead,eng_lead, afr_lead) %>%
  rename(Quebec = que_lead,
         European = fr_lead,
         Acadian = aca_lead,
         `L2 French` = eng_lead,
         African = afr_lead) %>% 
  mutate(id = 1: nrow(st_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)

edu_df <- st_french %>% 
  select(que_edu, fr_edu, aca_edu, eng_edu, afr_edu) %>%
  rename(Quebec = que_edu,
         European = fr_edu,
         Acadian = aca_edu,
         `L2 French` = eng_edu,
         African = afr_edu) %>% 
  mutate(id = 1: nrow(st_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)



--------------------------------------------------------------------------------------------------------------
# Perform repeated measures ANOVA and pair-wise t-tests are each status trait respectively  

# Professional
prof_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_prof <- get_anova_table(anova_test(data = prof_df, dv = value, wid = id, within = accent))
  

prof_pw <- prof_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1))) 

p_prof <- ggboxplot(prof_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(prof_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) + 
  labs(
    subtitle = get_test_label(res_prof, detailed = TRUE),
    caption = get_pwc_label(prof_pw),
    y = 'Score',
    title = 'Professional'
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))


--------------------------------------------------------------------------------------------------------------

# Leadership

lead_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_lead <- get_anova_table(anova_test(data = lead_df, dv = value, wid = id, within = accent))
  
lead_pw <- lead_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1)))

p_lead <- ggboxplot(lead_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(lead_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) + 
  labs(
    subtitle = get_test_label(res_lead, detailed = TRUE),
    caption = get_pwc_label(lead_pw),
    title = 'Leadership',
    y = 'Score',
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))

--------------------------------------------------------------------------------------------------------------

# Educated 
edu_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_edu <- get_anova_table(anova_test(data = edu_df, dv = value, wid = id, within = accent))
  

edu_pw <- edu_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1)))

p_edu <- ggboxplot(edu_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(edu_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) +
  labs(
    subtitle = get_test_label(res_edu, detailed = TRUE),
    caption = get_pwc_label(edu_pw),
    title = 'Educated',
    y = 'Score',
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))
  
```


```{r Status traits - result, fig.height= 7.9, fig.width= 8}
# plot
cowplot::plot_grid(p_prof,p_lead, p_edu)

# table
res_tbl_dt <- matrix(NA, nrow = 3, ncol = 7)

res_tbl_dt[1, 1:5]  <- pull(prof_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)

res_tbl_dt[2, 1:5]  <-pull(lead_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)

res_tbl_dt[3, 1:5]  <- pull(edu_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)


res_tbl_dt[, 6] <- c(res_prof$F, res_lead$F, res_edu$F)
res_tbl_dt[, 7] <- c(res_prof$p, res_lead$p, res_edu$p)

res_tbl_dt <- as.data.frame(res_tbl_dt)
colnames(res_tbl_dt) <- c('mean_Acadian', 'mean_African', 'mean_English','mean_European', 'mean_Quebec', 'F', 'p-value')
rownames(res_tbl_dt) <- c('Professional', 'Leadership', 'Social')
res_tbl_dt
```
2) This speaker is easy to understand. 
3) Would the person who did the recording be a good French teacher at UBC?
4) The speaker has a strong accent.

```{r Understandability}
# reverse the scale of question (4): The speaker has a strong accent.
accent_cols = recording_temp %>% 
  select(contains('_4')) %>%
  names

recording_temp[,accent_cols] = lapply(accent_cols,  function(x) 7 - recording_temp[, x])

# Combine the scores of same accent
und_french <- recording_temp %>% 
  select(contains(c('_2', '_3', '_4'))) %>%
  mutate(que_und = que_w_2 + que_b_2,
         fr_und = fr_b_2 + fr_w_2,
         aca_und = aca_b_2 + aca_w_2,
         eng_und = eng_w_2 + eng_b_2,
         afr_und = afr_b_2 + afr_w_2,
         que_teach = que_w_3 + que_b_3,
         fr_teach = fr_b_3 + fr_w_3,
         aca_teach = aca_b_3 + aca_w_3,
         eng_teach = eng_w_3 + eng_b_3,
         afr_teach = afr_b_3 + afr_w_3,
         que_acc = que_w_4 + que_b_4,
         fr_acc = fr_b_4 + fr_w_4,
         aca_acc = aca_b_4 + aca_w_4,
         eng_acc = eng_w_4 + eng_b_4,
         afr_acc = afr_b_4 + afr_w_4)

# Convert to long format
und_df <- und_french %>% 
  select(que_und, fr_und, aca_und, eng_und, afr_und) %>%
  rename(Quebec = que_und,
         European = fr_und,
         Acadian = aca_und,
         `L2 French` = eng_und,
         African = afr_und
         ) %>% 
  mutate(id = 1: nrow(und_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)

teach_df <- und_french %>% 
  select(que_teach, fr_teach, aca_teach,eng_teach, afr_teach) %>%
  rename(Quebec = que_teach,
         European = fr_teach,
         Acadian = aca_teach,
         `L2 French` = eng_teach,
         African = afr_teach) %>% 
  mutate(id = 1: nrow(und_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)

acc_df <- und_french %>% 
  select(que_acc, fr_acc, aca_acc, eng_acc, afr_acc) %>%
  rename(Quebec = que_acc,
         European = fr_acc,
         Acadian = aca_acc,
         `L2 French` = eng_acc,
         African = afr_acc) %>% 
  mutate(id = 1: nrow(und_french)) %>% 
    gather(key = "accent", value = "value", Quebec, European, Acadian, `L2 French`, African) %>%
  convert_as_factor(id, accent)

--------------------------------------------------------------------------------------------------------------
# Perform repeated measures ANOVA and pair-wise t-tests  
  
# Easy to understand
und_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_und <- get_anova_table(anova_test(data = und_df, dv = value, wid = id, within = accent))
  

und_pw <- und_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1))) 

p_und <- ggboxplot(und_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(und_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) + 
  labs(
    subtitle = get_test_label(res_und, detailed = TRUE),
    caption = get_pwc_label(und_pw),
    y = 'Score',
    title = 'Easy to Understand'
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))

--------------------------------------------------------------------------------------------------------------

# Good teacher

teach_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_teach <- get_anova_table(anova_test(data = teach_df, dv = value, wid = id, within = accent))
  
teach_pw <- teach_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1)))

p_teach <- ggboxplot(teach_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(teach_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) + 
  labs(
    subtitle = get_test_label(res_teach, detailed = TRUE),
    caption = get_pwc_label(teach_pw),
    title = 'Good French Teacher',
    y = 'Score',
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))

--------------------------------------------------------------------------------------------------------------

# Weak Accent
acc_df %>% 
  group_by(accent) %>%
  get_summary_stats(value, type = "mean_sd")  

res_acc <- get_anova_table(anova_test(data = acc_df, dv = value, wid = id, within = accent))
  

acc_pw <- acc_df %>%
  pairwise_t_test(
    value ~ accent, paired = TRUE,
    p.adjust.method = "bonferroni"
    ) %>% 
  mutate(y.position = c(seq(12,21, by = 1)))

p_acc <- ggboxplot(acc_df, x = 'accent', y = "value", fill = "accent") + 
  rremove('legend') + 
  rremove('xlab') + 
  stat_pvalue_manual(acc_pw, vjust = 0.5, bracket.nudge.y = 0.5, size = 3, hide.ns = TRUE) +
  labs(
    subtitle = get_test_label(res_acc, detailed = TRUE),
    caption = get_pwc_label(acc_pw),
    title = 'Mild Accent',
    y = 'Score',
  ) + 
  theme(plot.caption = element_text(size=12),
        plot.subtitle=element_text(size=13, vjust= 1, face="italic", color="black"),
        axis.text.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        plot.title = element_text(size=15, face = 'bold'))

```

```{r Understandability - result, fig.height= 7.9, fig.width= 8}
# plot
cowplot::plot_grid(p_und,p_teach, p_acc)

# table
res_tbl_und <- matrix(NA, nrow = 3, ncol = 7)

res_tbl_und[1, 1:5]  <- pull(und_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)

res_tbl_und[2, 1:5]  <-pull(teach_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)

res_tbl_und[3, 1:5]  <- pull(acc_df %>% 
  group_by(accent) %>% 
  summarize(mean = round(mean(value), 1)), mean)


res_tbl_und[, 6] <- c(res_und$F, res_teach$F, res_acc$F)
res_tbl_und[, 7] <- c(res_und$p, res_teach$p, res_acc$p)

res_tbl_und <- as.data.frame(res_tbl_und)
colnames(res_tbl_und) <- c('mean_Acadian', 'mean_African', 'mean_English','mean_European', 'mean_Quebec', 'F', 'p-value')
rownames(res_tbl_und) <- c('Easy to Understand', 'Good French Teacher', 'Mild Accent')
res_tbl_und
```

```{r}
acc_pw
```




# Check the effect of race


```{r data cleaning}
# re-clean the data: combine the score 

recording_df <- data %>% 
  select(c(20:129)) %>% 
  select(-c(`1B`, `2B`, `3B`, `4B`, `4B`, `5B`, `6B`, `7B`, `8B`, `9B`, `10B`)) %>%
  mutate(across(where(is.character), as.numeric)) %>%
  mutate(id = 1: nrow(data),
         id = as.factor(id)) 

accent_cols_II <- recording_df %>% 
  select(contains('_4')) %>%
  names

recording_df[,accent_cols_II] = lapply(accent_cols_II,  function(x) 7 - recording_df[, x])


recording_df <- recording_df %>%
  relocate(id, .before = `1A_1`) %>% 
  mutate(block_1 = rowSums(.[2:11]),
         block_2 = rowSums(.[12:21]),
         block_3 = rowSums(.[22:31]),
         block_4 = rowSums(.[32:41]),
         block_5 = rowSums(.[42:51]),
         block_6 = rowSums(.[52:61]),
         block_7 = rowSums(.[62:71]),
         block_8 = rowSums(.[72:81]),
         block_9 = rowSums(.[82:91]),
         block_10 = rowSums(.[92:101])) %>%
  select(id, block_1, block_2, block_3, block_4, block_5, block_6, block_7, block_8, block_9, block_10)

# convert to long format
recording_df_long <- recording_df %>% 
  pivot_longer(-c(id), values_to = "score", names_to = "block") %>% 
  mutate(race = case_when(block %in% c('block_1', 'block_4', 'block_7', 'block_8', 'block_9')~'white',
                          block %in% c('block_2', 'block_3', 'block_5', 'block_6', 'block_10')~'black'),
         accent = case_when(block %in% c('block_1', 'block_6')~'Quebec',
                            block %in% c('block_2', 'block_9')~'European',
                            block %in% c('block_3', 'block_8')~'Acadian',
                            block %in% c('block_4', 'block_10')~'English',
                            block %in% c('block_5', 'block_7')~'African')) 
  

# potential confounders                
conf <- data %>% mutate(id = 1: nrow(data),
                id = as.factor(id)) %>%
  select(id,gender, age, num_of_language, type_of_french, teacher_origin) %>%
  mutate(across(where(is.character), as.factor))
  
recording_df_long <- recording_df_long %>% 
  right_join(conf, on = 'id')

```



## Paired t test and  Wilcoxon test
```{r two-sample t test}
# black speakers
b_df <- recording_df_long %>%
  filter(race == "black")
# white speakers
w_df <- recording_df_long %>%
  filter(race == "white")

# one-sided t-test
t.test(b_df$score, w_df$score, alternative= "greater", paired = TRUE) 

# one-sided Wilcoxon test
wilcox.test(b_df$score, w_df$score, alternative= "greater", paired = TRUE)

```
## Two-way repeated measures ANOVA


```{r violin plot, fig.width=6, fig.height=3}
recording_df_long <- recording_df_long %>%
  mutate(accent = as.character(accent)) %>%   
  mutate(accent = replace(accent, accent == 'English', 'L2 French'))

recording_df_long %>%
  ggplot(aes(x=accent, y=score, fill=race)) +
  geom_violin(position=position_dodge(1), alpha=0.5) + 
  geom_boxplot(width=.1, outlier.colour=NA, position=position_dodge(1), fill = 'white', aes(group = interaction(race, accent))) +
  viridis::scale_fill_viridis(discrete=T, name="") +
  hrbrthemes::theme_ipsum() + 
  labs(x = 'Accent', y = 'Score') + 
  theme(axis.title.x = element_text(size = 15,face = 'bold'),
        axis.title.y = element_text(size = 15,face = 'bold'),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15))
```


```{r Two-way repeated measures ANOVA}
res.aov.twoway <- anova_test(
  data = recording_df_long, dv = score, wid = id,
  within = c(accent, race)
  )
get_anova_table(res.aov.twoway)  
```
```{r Two-way repeated measures ANOVA - result}
# pairwise t-test
pwc <- recording_df_long %>%
  group_by(accent) %>%
  pairwise_t_test(
    score ~ race, paired = TRUE,
    p.adjust.method = "bonferroni",
    alternative = 'greater'
    )

pwc <- pwc %>% add_xy_position(x = "accent")


ggboxplot(
  recording_df_long, x = "accent", y = "score",
  color = "race", palette = "jco"
  ) + 
  stat_pvalue_manual(pwc, tip.length = 0, hide.ns = TRUE) +
  labs(
    subtitle = get_test_label(res.aov, detailed = TRUE),
    caption = get_pwc_label(pwc),
    y = 'Score',
    x = 'Accent'
  ) + 
  theme(axis.title.x = element_text(size = 15,face = 'bold'),
        axis.title.y = element_text(size = 15,face = 'bold'),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15))

pwc
```

```{r Examine the group of European and English}
recording_df_long %>% 
  filter(accent == 'European' |
         accent == 'English') %>% 
  group_by(accent, race) %>%
  summarise(mu = mean(score),
            sd = sd(score))
```


## LME 

```{r check random effect, fig.width=6, fig.height=10}
# fit individual linear regression models to check within-subject difference
fit_lm <- lme4::lmList(score ~ race + accent|id, data = as.data.frame(recording_df_long))

plot(confint(fit_lm))
# It's easy that the confidence interval for individual intercepts and individual slopes do not overlap suggesting that random effect may be need for both the interval and slopes in the mixed effect model. 
```

```{r change baseline}
recording_df_long <- recording_df_long %>%
  mutate(race = as.factor(race),
         accent = as.factor(accent))

# make white speakers who speaker European French as baseline
recording_df_long <- within(recording_df_long, race <-  relevel(race, ref ='white'))
recording_df_long <- within(recording_df_long, accent <-  relevel(accent, ref ='European'))
```

```{r Fit LMEs}
# adding random effect to intercept 
lme_1 <-  lmer(score ~ race + accent + (1|id), data = as.data.frame(recording_df_long))
summary(lme_1)

# random intercept and slope (both race and accent)

# this model triggers singular fit
lme_2 <-  lmer(score ~ race + accent +  (1 + race + accent|id), data = as.data.frame(recording_df_long))
summary(lme_2)


# random effect to intercept and accent
lme_3 <-  lmer(score ~ race + accent +  (1 + accent|id), data = as.data.frame(recording_df_long))
summary(lme_3)
```

```{r Compare LMEs}
anova(lme_1, lme_2, lme_3)
# the random intercept and random accent model lme_3 obviously fits the best because of its smallest AIC and BIC. In additional, the p-value indicates the significance. 
```


```{r Check assumptions}
plot(lme_3, xlab = 'Fitted Values', ylab = 'Standardized Residuals')

# qqplot
qqnorm(resid(lme_3))
```


```{r Model estimate visualization}
# plot
sjPlot::plot_model(lme_3, 
                   axis.labels=c("Quebec Accent", "English Accent", "African Accent", "Acadian Accent", "Black Speakers"),
                   show.values=TRUE, show.p=TRUE,
                   title="Effect of Race and Accent on Lanaguage Attitude")
# Table (this one is more explicit)
sjPlot::tab_model(lme_3, 
                  show.re.var= TRUE, 
                  pred.labels =c("(Intercept)", "Black Speakers", "Acadian Accent", "African Accent", "English Accent", "Quebec Accent"),
                  dv.labels= "Effect of Race and Accent on Lanaguage Attitude")
```


```{r New: Fit LMEs}
# random intercept
lme_4 <-  lmer(score ~ race + accent + race*accent + (1|id), data = as.data.frame(recording_df_long), REML = FALSE, 
          control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='nlminb')))

# random intercept and random slope for accent
lme_5 <-  lmer(score ~ race + accent + race*accent + (1 + accent|id), data = as.data.frame(recording_df_long), REML = FALSE, 
          control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='nlminb')))


# random intercept and random slope for accent and race
lme_6 <-  lmer(score ~ race + accent + race*accent + (1 + race + accent|id), data = as.data.frame(recording_df_long), REML = FALSE, 
          control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='nlminb')))

# random intercept and random slope for accent and race
lme_7 <-  lmer(score ~ race + accent + race*accent + (1 + race|id), data = as.data.frame(recording_df_long), REML = FALSE, 
          control = lmerControl(
                           optimizer ='optimx', optCtrl=list(method='nlminb')))
```

```{r New: Compare LMEs}
anova(lme_4,lme_5, lme_6, lme_7)
```


```{r New: Check assumptions}
plot(lme_5, xlab = 'Fitted Values', ylab = 'Standardized Residuals')

# qqplot
qqnorm(resid(lme_5))
```


```{r New: Model estimate visualization}
# summary 
summary(lme_5)

# plot
sjPlot::plot_model(lme_5, 
                   #axis.labels=c("Quebec Accent", "English Accent", "African Accent", "Acadian Accent", "Black Speakers"),
                   show.values=TRUE, show.p=TRUE,
                   title="Effect of Race and Accent on Lanaguage Attitude")
# Table (this one is more explicit)
sjPlot::tab_model(lme_5, 
                  show.re.var= TRUE, 
                  #pred.labels =c("(Intercept)", "Black Speakers", "Acadian Accent", "African Accent", "English Accent", "Quebec Accent"),
                  dv.labels= "Effect of Race and Accent on Lanaguage Attitude")
```

```{r Model estimate in latex format}
stargazer::stargazer(lme_5, type = 'text')
```

```{r Interaction Plot}
interaction.plot(x.factor = recording_df_long$accent, #x-axis variable
                 trace.factor = recording_df_long$race, #variable for lines
                 response = recording_df_long$score)
```

```{r Marginal Mean}
em_lme_5 <- (emmeans(lme_5, ~ accent*race))
em_lme_5
```


## GEE

```{r GEE model}
library(geepack)

geeglm(score ~ race + accent,
       id = id,
       data = test_df,
       family = gaussian,
       corstr = "independence")


gee_ex <- geeglm(score ~ race + accent,
       id = id,
       data = test_df,
       family = gaussian,
       corstr = "exchangeable")

summary(gee_ex)
```


```{r New: GEE model}

geeglm(score ~ race + accent + race*accent,
       id = id,
       data = recording_df_long,
       family = gaussian,
       corstr = "independence")

geeglm(score ~ race + accent + race*accent,
       id = id,
       data = recording_df_long,
       family = gaussian,
       corstr = "ar1")


gee_ex_new <- geeglm(score ~ race + accent + race*accent,
       id = id,
       data = recording_df_long,
       family = gaussian,
       corstr = "exchangeable")


summary(gee_ex_new)
```



## Linear Regression Model

```{r Fit a unverse linear regression model}
summary(lm(score ~ race + accent + race*accent, data = recording_df_long))
```

Linear regression model (demo)
$$
y_{ij} = \beta_{0} + \beta_{1} x_{ij} + e_{ij}
$$

Linear mixed effect model
$$
y_{ij} = (\beta_{0} + b_{ij}) + (\beta_{1} + b_{i})x_{ij} + e_{ij}
$$


## Investigate the socie-demongraphic information vs scores

Covariate:
* The country of birth  
* Preferred type of French to learn   
* Origin of French teacher 


```{r attached continent and teacher continent to wide format}
# wide format
recording_df_sum <- recording_df %>% left_join(data %>% 
  mutate(id = 1:nrow(data),
         id = as.factor(id)) %>%
  mutate(continent = case_when(country_of_birth %in% c('Pakistan', 'Philippines', 'China', 'Hong Kong (S.A.R.)', 'India', 'Iran', 'Japan', 'Kazakhstan', 'South Korea', 'Taiwan', 'Turkey', 'Israel', 'Malaysia', 'Viet Nam', 'United Arab Emirates', 'Brunei Darussalam', 'Iraq') ~ 'Asia',
                              country_of_birth %in% c('Brazil', 'Colombia', 'United States of America', 'Dominica', 'USA') ~ 'America',
                              country_of_birth %in% c('Croatia', 'Czech Republic', 'Russian Federation', 'United Kingdom of Great Britain and Northern Ireland', 'Ukraine', 'Turkey', 'Romania', 'Monaco') ~ 'Europe',
                              country_of_birth %in% c('Mauritius', 'Tunisia') ~ 'Africa',
                              country_of_birth == 'Canada'~'Canada')) %>% 
  mutate(teacher_origin = replace(teacher_origin, teacher_origin_other == "Both French and Quebec", 'French and Quebec')) %>% 
  mutate(teacher_origin = replace(teacher_origin, teacher_origin_other == "French and Quebec", 'French and Quebec')) %>%
  mutate(teacher_origin = replace(teacher_origin, teacher_origin_other == "Quebec and French", 'French and Quebec')) %>% 
  mutate(teacher_origin = replace(teacher_origin, teacher_origin == "Elsewhere (specify)", 'Elsewhere')) %>%
  select(id,gender, age, continent, continent, teacher_origin, type_of_french),
  on = 'id') %>% 
  mutate(score_sum = rowSums(.[2:11]),
         teacher_origin = as.factor(teacher_origin),
         continent = as.factor(continent))
```


Kruskal-Wallis test by rank is a non-parametric alternative to one-way ANOVA test, which extends the two-samples Wilcoxon test in the situation where there are more than two groups.   

However, the sample size for each group should be at least five
If a sample has fewer than five observations, the p-value can be inaccurate.  
Ref: https://support.minitab.com/en-us/minitab-express/1/help-and-how-to/modeling-statistics/anova/how-to/kruskal-wallis-test/before-you-start/data-considerations/ 

```{r kw-test: type_of_french}
kruskal.test(score_sum ~ type_of_french, data = recording_df_sum)

recording_df_sum %>% 
  dunn_test(score_sum ~ type_of_french, p.adjust.method = "bonferroni") 

recording_df_sum %>% 
  wilcox_test(score_sum ~ type_of_french, p.adjust.method = "bonferroni") 

```

```{r kw-test: type_of_french - removed Europe}
table(recording_df_sum$continent)

recording_df_sum_con <- recording_df_sum %>% 
  filter(continent != 'Europe')

kruskal.test(score_sum ~ continent, data = recording_df_sum_con)
```



```{r kw-test: teacher - removed teacher from both quebec and france}
table(recording_df_sum$teacher_origin)

recording_df_sum_teacher <- recording_df_sum %>% 
  filter(teacher_origin != 'French and Quebec')

kruskal.test(score_sum ~ teacher_origin, data = recording_df_sum_teacher)

recording_df_sum_teacher %>% 
  dunn_test(score_sum ~ teacher_origin, p.adjust.method = "bonferroni") 

```


Overall participants from Europe gave more positive feedback than other groups. We wanna see more details regarding accent
```{r overall boxplot grouped by continent/preference/teacher}
ggboxplot(recording_df_sum, x = "continent", y = "score_sum", 
          color = "continent", 
          ylab = "Score", xlab = "Continent")


ggboxplot(recording_df_sum, x = "teacher_origin", y = "score_sum", 
          color = "teacher_origin", 
          ylab = "Score", xlab = "Original of French Teacher")


ggboxplot(recording_df_sum, x = "type_of_french", y = "score_sum", 
          color = "type_of_french", 
          ylab = "Score", xlab = "Preferred Type of Language to Learn")
```

### Accent

```{r Boxplot: continent vs. accent, fig.width=8}
recording_df_long %>%
  ggplot(aes(x=continent, y=score, fill=continent)) +
  geom_boxplot(outlier.colour=NA, position=position_dodge(1)) +
  facet_wrap(~accent) + 
  viridis::scale_fill_viridis(discrete=T, name="") +
  hrbrthemes::theme_ipsum() + 
  theme_bw() + 
  labs(x = 'Continent/Country of Birth', y = 'Score') + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.6),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        strip.text = element_text(size=12),
        axis.text.y = element_text(size = 10),
        axis.text.x=element_blank()) 
  
```

```{r Mean score of continent across accent,fig.width=8, fig.height=3}
recording_df_long %>% 
  group_by(continent, accent) %>% 
  summarise(mean = mean(score)) %>% 
  ggplot(aes(x=accent, y=mean,col=continent))+
  geom_point() + 
  geom_line(aes(group = continent)) + 
  theme_bw() + 
  labs(x = 'Accent', y = 'Mean Score') + 
  scale_colour_discrete('Continent/Country of Birth') + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.6),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        strip.text = element_text(size=12),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10)) 
```

```{r KW-test on continent across accent}
# accent vs. continent
accent_df %>%
  drop_na() %>%
  filter(continent != 'Europe') %>%
  group_by(accent) %>%
  kruskal_test(score_sum ~ continent) 
```

```{r Boxplot: teacher vs. accent, fig.width=8, fig.height= 5}
recording_df_long %>%
  #mutate(teacher_origin=replace(teacher_origin, teacher_origin=='Elsewhere (specify)', 'Elsewhere')) %>%
  filter(is.na(teacher_origin) == FALSE) %>%
  ggplot(aes(x=teacher_origin, y=score, fill=teacher_origin)) +
  geom_boxplot(outlier.colour=NA, position=position_dodge(1)) +
  facet_wrap(~accent) + 
  viridis::scale_fill_viridis(discrete=T, name="") +
  hrbrthemes::theme_ipsum() + 
  labs(x = 'Origin of French Teacher', y = 'Score') + 
  theme_bw() + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.6),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        strip.text = element_text(size=12),
        axis.text.y = element_text(size = 10),
        axis.text.x=element_blank()) 
  
```

```{r Mean score of teach origins across accent, fig.height=3, fig.width=8}
recording_df_long %>% 
  filter(is.na(teacher_origin) == FALSE) %>%
  group_by(teacher_origin, accent) %>% 
  summarise(mean = mean(score)) %>% 
  ggplot(aes(x = accent, y=mean,col=teacher_origin))+
  geom_point() + 
  geom_line(aes(group = teacher_origin)) + 
  theme_bw() + 
  labs(x = 'Accent', y = 'Mean Score') + 
  scale_colour_discrete('Origin of French Teacher') + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.6),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        strip.text = element_text(size=12),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10)) 
```

```{r KW-test on origin of teach across accent}
# accent vs. teacher_origin
accent_df %>%
  drop_na() %>% 
  filter(teacher_origin != 'French and Quebec') %>%
  group_by(accent) %>%
  kruskal_test(score_sum ~ teacher_origin) 


accent_df %>%
  drop_na() %>% 
  filter(teacher_origin != 'French and Quebec' & accent == 'Acadian') %>%
  dunn_test(score_sum ~ teacher_origin, p.adjust.method = "bonferroni") 
```

```{r Boxplot: preference vs. accent, fig.width=8, fig.height= 5}
recording_df_long %>%
  filter(is.na(type_of_french) == FALSE) %>%
  ggplot(aes(x=type_of_french, y=score, fill=type_of_french)) +
  geom_boxplot(outlier.colour=NA, position=position_dodge(1)) +
  facet_wrap(~accent) + 
  viridis::scale_fill_viridis(discrete=T, name="") +
  hrbrthemes::theme_ipsum() + 
  labs(x = 'Preferred Type of French to Learn', y = 'Score') + 
  theme_bw() + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.6),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        strip.text = element_text(size=12),
        axis.text.y = element_text(size = 10),
        axis.text.x=element_blank()) 
  
```

```{r Mean score of preference across accent, fig.height=3, fig.width=8}
recording_df_long %>% 
  filter(is.na(type_of_french) == FALSE) %>%
  group_by(type_of_french, accent) %>% 
  summarise(mean = mean(score)) %>% 
  ggplot(aes(x = accent, y=mean,col=type_of_french))+
  geom_point() + 
  geom_line(aes(group = type_of_french)) + 
  theme_bw() + 
  labs(x = 'Accent', y = 'Mean Score') + 
  scale_colour_discrete('Preferred Type of French to Learn') + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.6),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        strip.text = element_text(size=12),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 10)) 
```

### Race




```{r Boxplot: continent vs. race, fig.width=6, fig.height=3}
recording_df_long %>%
  ggplot(aes(x=continent, y=score, fill=continent)) +
  geom_boxplot(outlier.colour=NA, position=position_dodge(1)) +
  facet_wrap(~race) + 
  viridis::scale_fill_viridis(discrete=T, name= '') +
  hrbrthemes::theme_ipsum() + 
  theme_bw() + 
  labs(x = 'Continent/Country of Birth', y = 'Score') + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.6),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        axis.text.y = element_text(size = 10),
         axis.text.x=element_blank()) 

  
```







```{r Boxplot: teacher vs. race, fig.width=6, fig.height=3}
recording_df_long %>%
  filter(is.na(teacher_origin) == FALSE) %>%
  ggplot(aes(x=teacher_origin, y=score, fill=teacher_origin)) +
  geom_boxplot(outlier.colour=NA, position=position_dodge(1)) +
  facet_wrap(~race) + 
  viridis::scale_fill_viridis(discrete=T, name= '') +
  hrbrthemes::theme_ipsum() + 
  labs(x = 'Origin of French Teacher', y = 'Score') + 
  theme_bw() + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.8),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        axis.text.y = element_text(size = 10),
        axis.text.x=element_blank()) 
  
```



```{r Boxplot: Preference vs. race, fig.width=6, fig.height=3}
recording_df_long %>%
  filter(is.na(type_of_french) == FALSE) %>%
  ggplot(aes(x=type_of_french, y=score, fill=type_of_french)) +
  geom_boxplot(outlier.colour=NA, position=position_dodge(1)) +
  facet_wrap(~race) + 
  viridis::scale_fill_viridis(discrete=T, name= '') +
  hrbrthemes::theme_ipsum() + 
  labs(x = 'Preference for French Accent', y = 'Score') + 
  theme_bw() + 
  theme(axis.title.x = element_text(size = 12,face = 'bold', hjust = 0.5, vjust = -0.8),
        axis.title.y = element_text(size = 12,face = 'bold', vjust = 3, hjust = 0.5),
        axis.text.y = element_text(size = 10),
        axis.text.x=element_blank()) 
  
```

```{r KW test on Race}
race_res <- matrix(NA, ncol = 4, nrow = 6)

race_res[1:3, 1] <- 'black'
race_res[4:6, 1] <- 'white'

race_res[c(1:3, 4:6), 2] <- c('Continent/Countrty of Birth', 'Origins of French Teacher', 'Preferred Type of French to Learn')

race_res[c(1, 4), 3] <- pull(race_df %>%
  drop_na() %>%
  filter(continent != 'Europe') %>%
  group_by(race) %>%
  kruskal_test(score_sum ~ continent) %>%
  mutate_at(vars(statistic), funs(round(., 2))) %>% 
  select(statistic))

race_res[c(2, 5), 3] <- pull(race_df %>%
  drop_na() %>%
  filter(teacher_origin != 'French and Quebec') %>%
  group_by(race) %>%
  kruskal_test(score_sum ~ teacher_origin) %>%
  mutate_at(vars(statistic), funs(round(., 2))) %>% 
  select(statistic))

race_res[c(3, 6), 3] <- pull(race_df %>%
  drop_na() %>%
  group_by(race) %>%
  kruskal_test(score_sum ~ type_of_french) %>%
  mutate_at(vars(statistic), funs(round(., 2))) %>% 
  select(statistic))

race_res[c(1, 4), 4] <- pull(race_df %>%
  drop_na() %>%
  filter(continent != 'Europe') %>%
  group_by(race) %>%
  kruskal_test(score_sum ~ continent) %>%
  mutate_at(vars(p), funs(round(., 3))) %>% 
  select(p))

race_res[c(2, 5), 4] <- pull(race_df %>%
  drop_na() %>%
  filter(teacher_origin != 'French and Quebec') %>%
  group_by(race) %>%
  kruskal_test(score_sum ~ teacher_origin) %>%
  mutate_at(vars(p), funs(round(., 3))) %>% 
  select(p))

race_res[c(3, 6), 4] <- pull(race_df %>%
  drop_na() %>%
  group_by(race) %>%
  kruskal_test(score_sum ~ type_of_french) %>%
  mutate_at(vars(p), funs(round(., 3))) %>% 
  select(p))

race_res <- as.data.frame(race_res)
colnames(race_res) <- c('Race', 'Group Var', 'Test Statistics', 'P-value')
race_res
```


```{r Paired Two-sample Test on Race}

bind_cols(
recording_df_long %>% 
  group_by(continent, race) %>%
  summarise(race_mean = mean(score)) %>%
  mutate_at(vars(race_mean), funs(round(., 2))) %>%
  tidyr::pivot_wider(names_from = race, values_from = race_mean),

recording_df_long %>%
  group_by(continent) %>%
  wilcox_test(score ~ race, paired = TRUE) %>%
  mutate_at(vars(p), funs(round(., 3))) %>% 
  mutate_at(vars(statistic), funs(round(., 0))) %>% 
  select(statistic, p))



bind_cols(
recording_df_long %>% 
  filter(is.na(teacher_origin) == FALSE) %>% 
  group_by(teacher_origin, race) %>%
  summarise(race_mean = mean(score)) %>%
  mutate_at(vars(race_mean), funs(round(., 2))) %>%
  tidyr::pivot_wider(names_from = race, values_from = race_mean),

recording_df_long %>%
  filter(is.na(teacher_origin) == FALSE) %>% 
  group_by(teacher_origin) %>%
  wilcox_test(score ~ race, paired = TRUE) %>%
  mutate_at(vars(p), funs(round(., 3))) %>% 
  mutate_at(vars(statistic), funs(round(., 0))) %>% 
  select(statistic, p))


bind_cols(
recording_df_long %>% 
  filter(is.na(type_of_french) == FALSE) %>% 
  group_by(type_of_french, race) %>%
  summarise(race_mean = mean(score)) %>%
  mutate_at(vars(race_mean), funs(round(., 2))) %>%
  tidyr::pivot_wider(names_from = race, values_from = race_mean),

recording_df_long %>%
  filter(is.na(type_of_french) == FALSE) %>% 
  group_by(type_of_french) %>%
  wilcox_test(score ~ race, paired = TRUE) %>%
  mutate_at(vars(p), funs(round(., 3))) %>% 
  mutate_at(vars(statistic), funs(round(., 0))) %>% 
  select(statistic, p))

```
```{r Three-way ANOVA}
recording_df_long_full <- recording_df_long %>% filter(id != '17' & id != '25')

(res_type_of_french <- get_anova_table(recording_df_long_full %>% 
  select(id, score, race, accent, type_of_french) %>%
  anova_test(
  dv = score, wid = id,
  within = c(accent, race),
  between = c(type_of_french)
  )))


(res_continent <- get_anova_table(recording_df_long_full %>% 
  select(id, score, race, accent, continent) %>%
  filter(continent != 'Europe') %>%
  anova_test(
  dv = score, wid = id,
  within = c(accent, race),
  between = c(continent)
  )))

(res_teacher <- get_anova_table(recording_df_long_full %>% 
  select(id, score, race, accent, teacher_origin) %>%
  filter(teacher_origin != 'French and Quebec') %>%
  anova_test(
  dv = score, wid = id,
  within = c(accent, race),
  between = c(teacher_origin)
  )))


```

```{r Full LME model}

sjPlot::tab_model(lme_4, 
                  show.re.var= TRUE) 
```


## Preferred type of french to learn

1) I think this is beautiful French. 
2) This speaker is easy to understand. 
3) Would the person who did the recording be a good French teacher at UBC?
4) The speaker has a strong accent.
5) This person is dynamic.
6) This person is nice.
7) This person is social.
8) This person is professional.
8) This person is leader.
10) This person is educated.

```{r}
recording_temp_long_sep <- recording_temp %>% 
  mutate(id = 1:nrow(recording_temp),
         id = as.factor(id)) %>%
  pivot_longer(-c(id), values_to = "score", names_to = "trail") %>% 
  left_join(recording_df_sum %>% select(id, teacher_origin, type_of_french, continent), on = 'id') %>%
  mutate(accent = case_when(str_detect(trail, 'que') == TRUE~'Quebec',
                            str_detect(trail, '^fr') == TRUE~'European',
                            str_detect(trail, 'eng') == TRUE~'English',
                            str_detect(trail, 'afr') == TRUE~'African',
                            str_detect(trail, 'aca') == TRUE~'Acadian'),
         race = case_when(str_detect(trail, '_w') == TRUE~'White',
                          str_detect(trail, '_b') == TRUE~'Black'))



```




```{r fig.width=5.5, fig.height=2}
recording_temp_long_sep %>% 
  filter(trail %in% c('que_w_1', 'que_b_1', 'fr_b_1', 'fr_w_1', 'aca_b_1', 'aca_w_1', 'eng_w_1', 'eng_b_1', 'afr_w_1', 'afr_b_1')) %>%
  select(id, score, type_of_french, accent) %>% 
  mutate_if(is.character,as.factor) %>% 
  mutate(score = as.factor(score)) %>% 
  group_by(accent) %>% 
  ggplot(aes(x = accent, fill = score)) + 
  geom_bar(stat = "count", position = "stack") + 
  viridis::scale_fill_viridis(discrete = T) + 
  ggtitle('Is this beautiful French?',
          subtitle = 'Grouped by Preferred Type of French to Learn') + 
  labs(x = 'Accent', y = 'Count') + 
  hrbrthemes::theme_ipsum() + 
  facet_wrap(~type_of_french, scales = "free_y") + 
  theme(axis.title.x = element_text(size = 15,face = 'bold', hjust = 0.5),
        axis.title.y = element_text(size = 15,face = 'bold', hjust = 0.5),
        plot.subtitle= element_text(size= 13, hjust=0.5, face="italic", color="black"))
        #axis.text.y = element_text(size = 15),
        #axis.text.x = element_text(size = 15)) + 
  
```
```{r fig.width=5.5, fig.height=2}
recording_temp_long_sep %>% 
  filter(trail %in% c('que_w_3', 'que_b_3', 'fr_b_3', 'fr_w_3', 'aca_b_3', 'aca_w_3', 'eng_w_3', 'eng_b_3', 'afr_w_3', 'afr_b_3')) %>%
  select(id, score, type_of_french, accent) %>% 
  mutate_if(is.character,as.factor) %>% 
  mutate(score = as.factor(score)) %>% 
  group_by(accent) %>% 
  ggplot(aes(x = accent, fill = score)) + 
  geom_bar(stat = "count", position = "stack") +  
  viridis::scale_fill_viridis(discrete = T) + 
  hrbrthemes::theme_ipsum() + 
  facet_wrap(~type_of_french, scales = "free_y") +
  labs(x = 'Accent', y = 'Count') + 
  ggtitle('Would the person who did the recording be a good French teacher at UBC?',
          subtitle = 'Grouped by Preferred Type of French to Learn') + 
  theme(axis.title.x = element_text(size = 15,face = 'bold',hjust = 0.5),
        axis.title.y = element_text(size = 15,face = 'bold',hjust = 0.5),
        plot.subtitle= element_text(size= 13, hjust=0.5, face="italic", color="black")) 
  
```

```{r fig.width=4, fig.height=3}
recording_temp_long_sep %>% 
  filter(trail %in% c('que_w_1', 'que_b_1', 'fr_b_1', 'fr_w_1', 'aca_b_1', 'aca_w_1', 'eng_w_1', 'eng_b_1', 'afr_w_1', 'afr_b_1')) %>%
  select(id, score, teacher_origin, accent) %>% 
  filter(is.na(teacher_origin) == FALSE) %>%
  mutate_if(is.character,as.factor) %>% 
  mutate(score = as.factor(score)) %>% 
  group_by(accent) %>% 
  ggplot(aes(x = accent, fill = score)) + 
  geom_bar(stat = "count", position = "stack") + 
  viridis::scale_fill_viridis(discrete = T) + 
  ggtitle('Is this beautiful French?',
          subtitle = 'Grouped by Origin of French Teacher') + 
  labs(x = 'Accent', y = 'Count') + 
  hrbrthemes::theme_ipsum() + 
  facet_wrap(~teacher_origin, scales = "free_y", ncol = 2) + 
  theme(axis.title.x = element_text(size = 15,face = 'bold', hjust = 0.5),
        axis.title.y = element_text(size = 15,face = 'bold', hjust = 0.5),
        plot.subtitle= element_text(size= 13, hjust=0.5, face="italic", color="black"))
        #axis.text.y = element_text(size = 15),
        #axis.text.x = element_text(size = 15)) + 
  
```



```{r fig.width=4, fig.height=3}
recording_temp_long_sep %>% 
  filter(trail %in% c('que_w_3', 'que_b_3', 'fr_b_3', 'fr_w_3', 'aca_b_3', 'aca_w_3', 'eng_w_3', 'eng_b_3', 'afr_w_3', 'afr_b_3')) %>%
  select(id, score, teacher_origin, accent) %>% 
  filter(is.na(teacher_origin) == FALSE) %>%
  mutate_if(is.character,as.factor) %>% 
  mutate(score = as.factor(score)) %>% 
  group_by(accent) %>% 
  ggplot(aes(x = accent, fill = score)) + 
  geom_bar(stat = "count", position = "stack") + 
  viridis::scale_fill_viridis(discrete = T) + 
  hrbrthemes::theme_ipsum() + 
  labs(x = 'Accent', y = 'Count') + 
  facet_wrap(~teacher_origin, scales = "free_y", ncol = 2) +
  ggtitle('Would the person who did the recording be a good French teacher at UBC?',
          subtitle = 'Grouped by Origin of French Teacher') + 
  theme(axis.title.x = element_text(size = 15,face = 'bold',hjust = 0.5),
        axis.title.y = element_text(size = 15,face = 'bold',hjust = 0.5),
        plot.subtitle= element_text(size= 13, hjust=0.5, face="italic", color="black")) 
```

















